{{define "opdata"}}
{{$drawID := .ID}}
{{$teamID := .TeamID}}
<html lang="en">
<head>
<title>{{.Name}} Op data</title>
{{template "styles"}}
</head>
<body>
{{template "nav"}}
	<div class="content-sction-a">
		<div class="container">
			<div class="row">
				<div class="col-lg-12">
					<div class="content-section-a">
<!-- content starts here -->
<div class="card mb-2">
<div class="card-header">Op data</div>
<div class="card-body"></div>
<ul class="list-group list-group-flush">
<li class="list-group-item">Name: {{.Name}} (id: {{.ID}})</li>
<li class="list-group-item">Team: <a href="{{WebAPIPath}}/team/{{.TeamID}}/edit">{{.Team}}</a></li>
<li class="list-group-item"><a href="{{WebAPIPath}}/draw/{{.ID}}/stock">Stock Intel Link</a></li>
</ul>
</div>

<div class="card">
<div class="card-header">Links</div>
<div class="card-body">
 <div class="list-group container-fluid" id="linklist">
  <div class="list-group-item row">
     <span class="col-sm-1">Throw Order</span>
     <span class="col-sm-2">From</span>
     <span class="col-sm-2">To</span>
     <span class="col-sm-1">Distance</span>
     <span class="col-sm-3">Assigned To</span>
     <span class="col-sm-3">Description</span>
  </div>
{{range .Links}}
  <div class="list-group-item row">
     <span class="col-sm-1"><form action="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/link/{{.ID}}/order"><input type="text" name="pos" value="{{.ThrowOrder}}" size="3" disabled></form></span>
     <span class="col-sm-2"><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.FromID}}">{{.From}}</a></span>
     <span class="col-sm-2"><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ToID}}">{{.To}}</a></span>
     <span class="col-sm-1">{{.Distance}} KM</span>
     <span class="col-sm-3"><form action="#">{{OpUserMenu .AssignedToID $teamID .ID "agentAssignLink"}}</form></span>
     <span class="col-sm-3"><form action="#"><input type="text" name="desc" value="{{.Desc}}" onchange="assignLinkDesc({{.ID}}, this)"></form></span>
  </div>
{{end}}
 </div>
</div>
</div>
</div>

<div class="card mb-2">
<div class="card-header">Markers</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">Portal</th>
     <th scope="col">Type</th>
     <th scope="col">Assigned To</th>
     <th scope="col">Comment</th>
    </tr>
   </thead>
   <tbody>
	{{range .Markers}}
		<tr>
		<td><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.PortalID}}">{{.Portal}}</a></td>
		<td>{{.Type}}</td>
		<td><form action="#">{{OpUserMenu .AssignedToID $teamID .ID "agentAssignMarker"}}</form></td>
		<td><form action="#"><input type="text" name="comment" value="{{.Comment}}" onchange="assignMarkerComment({{.ID}}, this)"></form></td>
		</tr>
	{{end}}
   </tbody>
  </table>
</div>

<div class="card mb-2">
<div class="card-header">Keys Needed</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">Portal</th>
     <th scope="col">Keys Required</th>
     <th scope="col">On Hand</th>
    </tr>
   </thead>
   <tbody>
	{{range .Keys}}
		<tr>
		<td><a href="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ID}}">{{.Portal}}</a></td>
		<td>{{.Required}}</td>
		<td><form action="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/portal/{{.ID}}/onhand"><input type="text" name="onhand" value="" size="3" disabled></form></td>
		</tr>
	{{end}}
   </tbody>
  </table>
</div>
</div>

<div class="card mb-2">
<div class="card-header">Capsule Build List</div>
<div class="card-body">
  <table class="table">
   <thead>
    <tr>
     <th scope="col">Agent</th>
     <th scope="col">Portal</th>
     <th scope="col">Keys Required</th>
    </tr>
   </thead>
   <tbody>
     <td>TBD</td>
     <td>TBD</td>
     <td>TBD</td>
   </tbody>
  </table>
</div>
</div>

<div class="card mb-2">
<div class="card-header">Misc. Functions</div>
<div class="card-body">
  <table class="table">
   <tbody>
     <tr><td><form action="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/chown"><input type="text" name="to" value=""> <input type="submit" name="Change Owner" value="Change Owner"></form></td></tr>
     <tr><td><form action="{{WebAPIPath}}/draw/{{printf "%s" $drawID}}/chgrp">{{TeamMenu .Gid $teamID}} <input type="submit" name="Change Team" value="Change Team"></form></td></tr>
   </tbody>
  </table>
</div>
</div>
		<!-- content ends here -->				
					</div>
				</div>
			</div>

		</div>
		<!-- /.container -->

	</div>
	<!-- /.intro-header -->

{{template "footer"}}
{{template "bootstrapjs"}}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.js"></script>
<script>
var sortable = Sortable.create(linklist, {
  /* options */
});

function agentAssignLink(id, sel)
{
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/link/" + id + "/assign");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            /* xxx */
	}
    }
    xhr.send(encodeURI('agent=' + sel.value));
}

function agentAssignMarker(id, sel)
{
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/marker/" + id + "/assign");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            /* xxx */
	}
    }
    xhr.send(encodeURI('agent=' + sel.value));
}

function assignLinkDesc(id, sel)
{
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/link/" + id + "/desc");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            /* xxx */
	}
    }
    xhr.send(encodeURI('desc=' + sel.value));
}

function assignMarkerComment(id, sel)
{
    xhr = new XMLHttpRequest();
    xhr.open('POST', "/api/v1/draw/{{.ID}}/marker/" + id + "/comment");
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
        if (xhr.status === 200) {
            /* xxx */
	}
    }
    xhr.send(encodeURI('comment=' + sel.value));
}

</script>
</body>
</html>
{{end}}
